# Мониторинг затрат электричества

## Описание

Система автоматического мониторинга затрат электричества для майнинг-фермы. Данные записываются каждые 5 минут в локальные JSON файлы и синхронизируются с Supabase 2 раза в день.

## Особенности

- **Частота записи**: каждые 5 минут
- **Синхронизация с Supabase**: в 6:00 и 18:00 каждый день
- **Локальное хранение**: данные сохраняются в JSON файлах для надежности
- **Автоматическая очистка**: старые записи автоматически удаляются
- **Интеграция**: работает как часть основного скрипта мониторинга

## Структура файлов

```
electricity_data/
├── electricity_data.json      # Текущие данные (последние 1000 записей)
└── electricity_history.json   # Данные для синхронизации с Supabase
```

## Формат данных

### Запись электричества
```json
{
  "timestamp": "2024-01-15T10:30:00",
  "device_id": "device_001",
  "device_name": "Miner 1",
  "location": "location_1",
  "power_w": 1500.0,
  "energy_kwh": 0.125,
  "is_on": true,
  "voltage": 220.0,
  "current": 6.8
}
```

### Файл текущих данных
```json
{
  "last_update": "2024-01-15T10:30:00",
  "records": [...],
  "total_records": 150
}
```

### Файл истории
```json
{
  "last_sync": "2024-01-15T06:00:00",
  "pending_records": [...],
  "total_pending": 45
}
```

## Как это работает

1. **Мониторинг**: Основная функция `monitor_devices()` в `main.py` проверяет устройства каждые 30 секунд
2. **Запись данных**: Каждые 5 минут записываются данные о потреблении электричества
3. **Локальное сохранение**: Данные сохраняются в JSON файлы в директории `electricity_data/`
4. **Синхронизация**: В 6:00 и 18:00 данные отправляются в Supabase
5. **Очистка**: После успешной синхронизации локальные записи очищаются

## Интеграция в main.py

Мониторинг электричества интегрирован в существующую функцию `monitor_devices()`:

- Добавлены функции `save_electricity_data()` и `sync_electricity_to_supabase()`
- Запись данных происходит каждые 5 минут
- Синхронизация с Supabase в 6:00 и 18:00
- Все данные логируются для отладки

## Тестирование

Для тестирования используйте скрипт `test_electricity_monitor.py`:

```bash
python test_electricity_monitor.py
```

Скрипт проверит:
- Создание файлов данных
- Структуру JSON файлов
- Имитацию нескольких измерений

## Настройка

### Переменные окружения
Убедитесь, что в `.env` файле настроены:
- `SUPABASE_URL` - URL вашей Supabase базы
- `SUPABASE_KEY` - API ключ Supabase

### Конфигурация устройств
Устройства должны быть настроены в базе данных Supabase в таблице `miner_devices_config`.

## Мониторинг и логи

Все операции логируются в основной лог файл `mining_calculator.log`:

- `INFO` - успешные операции
- `DEBUG` - детальная информация
- `WARNING` - предупреждения
- `ERROR` - ошибки

## Преимущества решения

1. **Надежность**: Данные сохраняются локально, даже если сервер выключится
2. **Экономия ресурсов**: Синхронизация с Supabase только 2 раза в день
3. **Простота**: Интегрировано в существующий код без усложнения
4. **Автоматизация**: Не требует ручного вмешательства
5. **Масштабируемость**: Легко добавить новые устройства

## Устранение неполадок

### Проблема: Данные не записываются
- Проверьте логи на наличие ошибок
- Убедитесь, что устройства активны в конфигурации
- Проверьте права доступа к директории `electricity_data/`

### Проблема: Синхронизация не работает
- Проверьте подключение к Supabase
- Убедитесь, что API ключи корректны
- Проверьте структуру таблицы `miner_energy_sessions`

### Проблема: Файлы не создаются
- Проверьте права доступа к текущей директории
- Убедитесь, что импорты работают корректно
- Проверьте логи на наличие ошибок импорта

## Разработка

Для добавления новых функций:
1. Модифицируйте функции в `main.py`
2. Обновите тестовый скрипт
3. Проверьте работу на тестовых данных
4. Обновите документацию

## Поддержка

При возникновении проблем:
1. Проверьте логи
2. Запустите тестовый скрипт
3. Проверьте конфигурацию
4. Обратитесь к документации Supabase API
